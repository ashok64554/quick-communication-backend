CREATE DEFINER=`root`@`localhost` EVENT `daily-submission-logs` ON SCHEDULE EVERY 1 DAY STARTS '2023-05-25 03:00:00' ON COMPLETION NOT PRESERVE ENABLE DO CALL `migrateDailyLogs`()

CREATE DEFINER=`root`@`localhost` EVENT `update-report` ON SCHEDULE EVERY 5 MINUTE STARTS '2022-08-25 16:45:00' ON COMPLETION NOT PRESERVE ENABLE DO UPDATE `send_sms` SET `total_delivered` = (SELECT COUNT(*) FROM `send_sms_queues` WHERE `send_sms`.`id` = `send_sms_queues`.`send_sms_id` AND `stat` = 'DELIVRD') + (SELECT COUNT(*) FROM `send_sms_histories` WHERE `send_sms`.`id` = `send_sms_histories`.`send_sms_id` AND `stat` = 'DELIVRD'), 
            `total_failed` = (SELECT COUNT(*) FROM `send_sms_queues` WHERE `send_sms`.`id` = `send_sms_queues`.`send_sms_id` AND `stat` NOT IN ('Pending','Accepted','Invalid','BLACK','DELIVRD')) + (SELECT COUNT(*) FROM `send_sms_histories` WHERE `send_sms`.`id` = `send_sms_histories`.`send_sms_id` AND `stat` NOT IN ('Pending','Accepted','Invalid','BLACK','DELIVRD')),
            `total_block_number` = (SELECT COUNT(*) FROM `send_sms_queues` WHERE `send_sms`.`id` = `send_sms_queues`.`send_sms_id` AND `stat` = 'BLACK') + (SELECT COUNT(*) FROM `send_sms_histories` WHERE `send_sms`.`id` = `send_sms_histories`.`send_sms_id` AND `stat` = 'BLACK'),
            `total_invalid_number` = (SELECT COUNT(*) FROM `send_sms_queues` WHERE `send_sms`.`id` = `send_sms_queues`.`send_sms_id` AND `stat` = 'Invalid') + (SELECT COUNT(*) FROM `send_sms_histories` WHERE `send_sms`.`id` = `send_sms_histories`.`send_sms_id` AND `stat` = 'Invalid'),
            `status` = CASE WHEN `total_contacts` <= (`total_block_number` + `total_invalid_number` + `total_delivered` + `total_failed`) THEN 'Completed' ELSE `status` END
            WHERE `status` = 'Ready-to-complete'
